---
import 'prismjs/themes/prism-coy.min.css';
import '../../features/entry/entryContents.css';

import { getCollection, render } from 'astro:content';

import { pathList } from '../../../constants/pathList';
import { OG_IMAGE_PATH, SITE_URL } from '../../../constants/siteData';
import PublicationMetadata from '../../features/entry/components/PublicationMetadata.astro';
import Taxonomy from '../../features/entry/components/Taxonomy.astro';
import { formatIsoString } from '../../features/entry/date';
import { createBlogPostingStructuredData } from '../../features/structured_data/blogPostingStructuredData';
import Body from '../../layouts/Body.astro';
import GlobalFooter from '../../layouts/GlobalFooter.astro';
import GlobalHeader from '../../layouts/GlobalHeader.astro';
import Head from '../../layouts/Head.astro';
import Html from '../../layouts/Html.astro';
import Main from '../../layouts/Main.astro';

export async function getStaticPaths() {
  const entries = await getCollection('entries');

  return entries.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { id } = entry;
const { Content } = await render(entry);
const { title: entryTitle, excerpt, tags = [], publishedAt, revisedAt } = entry.data;
const url = `${SITE_URL}/${pathList.entries}/${id}`;
const ogImageUrl = `${OG_IMAGE_PATH}/${id}.webp`;

const publishedDateString = formatIsoString(publishedAt);
const revisedDateString = formatIsoString(revisedAt ?? publishedAt);

const structuredData = JSON.stringify(
  createBlogPostingStructuredData({
    title: entryTitle,
    content: excerpt ?? '',
    publishedDateString,
    revisedDateString,
  }),
);
---

<style>
  article {
    position: relative;
  }

  article > footer {
    margin-top: var(--space-component-4);
  }

  .PublicationMetadata {
    margin-top: var(--space-component-2);
  }

  .Contents {
    margin-top: var(--space-component-4);
  }
</style>

<Html>
  <Head title={entryTitle} description={excerpt ?? ''} pageType="article" pageUrl={url} ogImageUrl={ogImageUrl}>
    <script type="application/ld+json" is:inline set:html={structuredData} />
  </Head>
  <Body>
    <GlobalHeader hasHeadings={false} />
    <Main>
      <article>
        <header>
          <h1>{entryTitle}</h1>
          <div class="PublicationMetadata">
            <PublicationMetadata publishedAt={publishedAt} revisedAt={revisedAt} />
          </div>
        </header>
        <div class="Contents">
          <Content />
        </div>
        <footer>
          {tags.length > 0 && <Taxonomy tags={tags} />}
        </footer>
      </article>
    </Main>
    <GlobalFooter />
  </Body>
</Html>
